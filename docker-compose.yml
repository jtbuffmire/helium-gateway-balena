version: "2.4"

services:

  cs-mux:
    build: ./cs-mux
    restart: unless-stopped
    # ports: ["9090:9090"]      # To later activate Prometheus metrics
    
  # Seeds the named volume exactly once (keeps existing files via -n)
  rak-config-seed:
    build: ./rak-config-seed
    volumes:
      - rak-config:/app/config
    command: sh -c 'mkdir -p /app/config && cp -vn /seed/* /app/config/ && sleep infinity'
    restart: unless-stopped

  udp-packet-forwarder:
    build: ./udp-packet-forwarder
    # ports:
    #   - "127.0.0.1:1700:1700/udp"
    restart: unless-stopped
    depends_on:
      - cs-mux
      - rak-config-seed
    privileged: true
    devices:
      - /dev/spidev0.0
      - /dev/spidev0.1
      - /dev/gpiochip0
      - /dev/gpiochip1
  
    # Power cycle happens via Dockerfile modification - no command override needed
    
    # (Balena only) helpful feature labels:
    labels:
      io.balena.features.sysfs: '1'
      io.balena.features.procfs: '1'
      io.balena.features.kernel-modules: '1'
    volumes:
      - rak-config:/app/config
    environment:
      # Point the forwarder to the multiplexer (same compose network)
      SERVER_HOST: cs-mux
      SERVER_PORT: "1700"

      # Concentrator (SPI Corecell HAT)
      MODEL: RAK2287
      INTERFACE: SPI
      DEVICE: /dev/spidev0.0
      # Use character-device GPIO (not sysfs)
      # - SERVER_HOST: "127.0.0.1"
      GATEWAY_EUI_SOURCE: chip  # use SX1302 chip EUI for a stable gateway EUI
      USE_LIBGPIOD: "1"
      GPIO_CHIP: gpiochip0
      RESET_GPIO: "17"       # RAK2287 HAT typical
      POWER_EN_GPIO: "18"    # RAK2287 HAT typical
      POWER_EN_LOGIC: "1"    # 1=active-high (power on = GPIO HIGH), 0=active-low

      # region (RAK image understands BAND / us_902_928 or US915)
      BAND: us_902_928

      # CONCENTRATOR_MODEL: RAK2287
      # CONCENTRATOR_CHIP: SX1302
      # FREQUENCY_BAND: us_902_928
      
      # Avoid TTN auto-targeting:
      TTS_REGION: ""              # unset/blank; remove TTN/TTS_* if present

      # optional; start conservative if 8 MHz is flaky:
      # SPI_SPEED: "4000000"

  gateway-rs:
     image: quay.io/team-helium/miner:gateway-latest
     restart: unless-stopped
     devices:
       - /dev/i2c-1:/dev/i2c-1
     volumes:
       - helium-gateway-data:/etc/helium_gateway
     environment:
       - GW_REGION=US915
       - GW_LISTEN=0.0.0.0:1680
       - GW_API=0.0.0.0:4467
       - GW_KEYPAIR=/etc/helium_gateway/gateway_key.bin
       - REGION_OVERRIDE=US915
       - RUST_LOG=debug
     depends_on:
       - cs-mux
volumes:
  rak-config: {}
  helium-gateway-data: {}