# Docker Compose for Helium Gateway with RAK2287 and gwmp-mux
version: '2.4'

services:
  gateway-service:
    build: ./gateway-service
    restart: unless-stopped
    networks:
      - gateway-net
    ports:
      - "1680:1680/udp"  # GWMP port for gwmp-mux connection
      - "4467:4467"      # Gateway API port
    volumes:
      - gateway-data:/etc/helium_gateway
      - gateway-logs:/var/log
    devices:
        - "/dev/i2c-1:/dev/i2c-1" 
    cap_add:
      - SYS_RAWIO
    environment:
      - REGION_OVERRIDE=${REGION_OVERRIDE:-US915}
    labels:
      io.balena.features.balena-api: '1'
      io.balena.features.supervisor-api: '1'

  gwmp-mux:
    build: ./gwmp-mux
    restart: unless-stopped
    networks:
      - gateway-net
    ports:
      - "1700:1700/udp"  # GWMP port for packet forwarder connection
    volumes:
      - gwmp-config:/etc/gwmp-mux
    environment:
      - GWMP_MUX_BIND=0.0.0.0:1700
    depends_on:
      - gateway-service

  packet-forwarder:
    image: rakwireless/udp-packet-forwarder:latest
    container_name: packet-forwarder
    restart: unless-stopped
    privileged: true
    networks:
      - gateway-net
    environment:
      MODEL: "RAK2287"
      INTERFACE: "SPI"
      HAS_GPS: 0
      HAS_LTE: 0
      RESET_GPIO: 15
      POWER_EN_GPIO: 23
      RADIO_DEV: "/dev/spidev0.0"
      # GATEWAY_EUI: ""
      BAND: "us_902_928"
      SERVER_HOST: "gwmp-mux"  # Point to gwmp-mux service
      SERVER_PORT: 1700
      GPS_LATITUDE: 38.851137
      GPS_LONGITUDE: -121.269953
      GPS_ALTITUDE: 0
    depends_on:
      - gwmp-mux

networks:
  gateway-net:
    driver: bridge

volumes:
  gateway-data:
  gateway-logs:
  gwmp-config: